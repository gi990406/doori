{% extends "../base.html" %}
{% load static humanize %}
{% block content %}
  <td width="800" valign="top">
    <div id="order-title" aria-label="페이지 타이틀">
      <div class="title">
        <img src="{% static 'images/parts/order_write.png' %}" alt="주문서 작성">
      </div>
    </div>
    <div id="order-summary">
      <table>
        <colgroup>
          <col>
          {# 상품 #}
          <col style="width:120px">
          {# 수량 #}
          <col style="width:160px">
          {# 단가 #}
          <col style="width:180px">
          {# 소계 #}
        </colgroup>
        <thead>
          <tr>
            <th>상품</th>
            <th>수량</th>
            <th>단가</th>
            <th>소계</th>
          </tr>
        </thead>
        <tbody>
          {# 🔴 cart 대신 items 사용 (buy-now/장바구니 공통) #}
          {% for it in items %}
            {% with p=it.product %}
              <tr>
                <td>{{ p.title }}</td>
                <td>{{ it.qty }}</td>
                <td>
                  {% if it.price is None %}
                    <span class="warn">전화문의</span>
                  {% else %}
                    {{ it.price|floatformat:0|intcomma }}원
                  {% endif %}
                </td>
                <td>
                  {% if it.price %}
                    {{ it.subtotal|floatformat:0|intcomma }}원
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% if not it.stock_ok %}
                <tr>
                  <td colspan="4">
                    <span class="warn">⚠ 재고 부족으로 주문이 제한될 수 있습니다.</span>
                  </td>
                </tr>
              {% endif %}
            {% endwith %}
          {% empty %}
            <tr>
              <td colspan="4">주문할 상품이 없습니다.</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4">
              <b>총 상품금액:</b> {{ total_amount|floatformat:0|intcomma }}원
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    <br>
    <form method="post">
      {% csrf_token %}
      {# 🔵 buy-now로 들어왔으면 POST 때도 값 유지 (중요) #}
      {% if buy_now_part_id %}
        <input type="hidden" name="part_id" value="{{ buy_now_part_id }}">
        <input type="hidden" name="qty" value="{{ buy_now_qty|default:1 }}">
      {% endif %}
      {% if not is_member %}
        <fieldset style="border:1px solid #eee; padding:12px;">
          <legend>비회원 정보</legend>
          <div style="margin-bottom:8px;">
            이름
            <input type="text" name="name" required>
            &nbsp; 휴대폰
            <input type="text" name="hp" required placeholder="010-1234-5678">
            &nbsp; 이메일
            <input type="email" name="email" required>
          </div>
          <div>
            주문 비밀번호
            <input type="password" name="password" required placeholder="주문 조회용">
          </div>
        </fieldset>
        <br>
      {% else %}
        <div style="padding:8px; background:#f8fafc; border:1px solid #eee;">
          로그인 주문입니다. ({{ default_name }} / {{ default_hp }} / {{ default_email }})
        </div>
        <br>
      {% endif %}
      <div style="margin-bottom:10px;">
        요청사항(메모):
        <br>
        <textarea name="memo" rows="3" style="width:100%;"></textarea>
      </div>
      <div style="padding:12px;
                  background:#fffbea;
                  border:1px solid #fde68a;
                  border-radius:6px">
        <b>입금 안내</b>
        <br>
        <br>
        주문 후 아래 계좌로 송금해주세요. 송금 후 문자로 알려주시면 관리자가 확인 후 연락드리겠습니다.
        <br>
        <br>
        농협 01020108272-19 (정경수)
        <br>
        신협 01020108272 (정경수)
      </div>
      <br>
      <button type="submit" class="btn btn-primary">주문하기</button>
      {% if using_cart %}
        <a href="{% url 'shop:cart_detail' %}" class="btn">장바구니로 돌아가기</a>
      {% endif %}
    </form>
  </td>
{% endblock %}
