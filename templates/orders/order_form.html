{% extends "../base.html" %}
{% load static humanize %}
{% block content %}
  <td width="800" valign="top">
    <div id="order-title" aria-label="페이지 타이틀">
      <div class="title">
        <img src="{% static 'images/parts/order_write.png' %}" alt="주문서 작성">
      </div>
    </div>
    <div id="order-summary">
      <table>
        <colgroup>
          <col>
          {# 상품 #}
          <col style="width:120px">
          {# 수량 #}
          <col style="width:160px">
          {# 단가 #}
          <col style="width:180px">
          {# 소계 #}
        </colgroup>
        <thead>
          <tr>
            <th>상품</th>
            <th>수량</th>
            <th>단가</th>
            <th>소계</th>
          </tr>
        </thead>
        <tbody>
          {# 🔴 cart 대신 items 사용 (buy-now/장바구니 공통) #}
          {% for it in items %}
            {% with p=it.product %}
              <tr>
                <td>{{ p.title }}</td>
                <td>{{ it.qty }}</td>
                <td>
                  {% if it.price is None %}
                    <span class="warn">전화문의</span>
                  {% else %}
                    {{ it.price|floatformat:0|intcomma }}원
                  {% endif %}
                </td>
                <td>
                  {% if it.price %}
                    {{ it.subtotal|floatformat:0|intcomma }}원
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% if not it.stock_ok %}
                <tr>
                  <td colspan="4">
                    <span class="warn">⚠ 재고 부족으로 주문이 제한될 수 있습니다.</span>
                  </td>
                </tr>
              {% endif %}
            {% endwith %}
          {% empty %}
            <tr>
              <td colspan="4">주문할 상품이 없습니다.</td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4">
              <b>총 상품금액:</b> {{ total_amount|floatformat:0|intcomma }}원
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    <br>
    <form class="order-wrap"
          method="post"
          action="{% url 'shop:order_create' %}"
          novalidate>
      {% csrf_token %}
      {# buy-now 유지값 #}
      {% if buy_now_part_id %}
        <input type="hidden" name="part_id" value="{{ buy_now_part_id }}">
        <input type="hidden" name="qty" value="{{ buy_now_qty|default:1 }}">
      {% endif %}
      {% if not is_member %}
        <div class="order-card" role="group" aria-labelledby="guest-info-title">
          <div id="guest-info-title" class="order-section-title">비회원 정보</div>
          <div class="order-grid">
            <div class="order-row">
              <label class="order-label" for="guest-name">이름</label>
              <input class="order-input"
                     id="guest-name"
                     type="text"
                     name="guest_name"
                     required
                     autocomplete="name"
                     placeholder="홍길동">
            </div>
            <div class="order-row">
              <label class="order-label" for="guest-hp">휴대폰</label>
              <input class="order-input"
                     id="guest-hp"
                     type="text"
                     name="guest_hp"
                     required
                     inputmode="numeric"
                     pattern="^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$"
                     placeholder="010-1234-5678"
                     autocomplete="tel">
              <div class="order-hint">숫자만 또는 하이픈 포함 입력 가능</div>
            </div>
            <div class="order-row">
              <label class="order-label" for="guest-email">이메일</label>
              <input class="order-input"
                     id="guest-email"
                     type="email"
                     name="guest_email"
                     required
                     placeholder="you@example.com"
                     autocomplete="email">
            </div>
            <div class="order-row">
              <label class="order-label" for="guest-password">주문 비밀번호</label>
              <input class="order-input"
                     id="guest-password"
                     type="password"
                     name="guest_password"
                     required
                     autocomplete="new-password"
                     placeholder="주문 조회용 비밀번호">
              <div class="order-hint">비회원 주문 조회에 사용됩니다.</div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="order-auth-banner" role="status" aria-live="polite">
          <div class="order-auth-left">
            <div class="order-auth-text">
              <div class="order-auth-title">로그인 주문입니다.</div>
              <div class="order-auth-kv">
                {{ default_name }} <span class="dot">·</span>
                {{ default_hp }} <span class="dot">·</span>
                {{ default_email }}
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      <div class="order-card" role="group" aria-labelledby="memo-title">
        <div id="memo-title" class="order-section-title">요청사항(메모)</div>
        <textarea class="order-textarea"
                  name="memo"
                  rows="3"
                  placeholder="예) 배송 전 연락 부탁드립니다."></textarea>
      </div>
      <div class="order-payment">
        <b>입금 안내</b>
        <br>
        <br>
        주문 후 아래 계좌로 송금해주세요. 송금 후 문자로 알려주시면 관리자가 확인 후 연락드리겠습니다.
        <br>
        <br>
        농협 01020108272-19 (정경수)
        <br>
        신협 01020108272 (정경수)
      </div>
      <div class="order-actions">
        <button type="submit" class="btn btn-primary">주문하기</button>
        {% if using_cart %}
          <a href="{% url 'shop:cart_detail' %}" class="btn">장바구니로 돌아가기</a>
        {% endif %}
      </div>
    </form>
  </td>
{% endblock %}
