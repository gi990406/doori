{% extends "../base.html" %}
{% load static %}
{% block content %}
  <td width="800" valign="top">
    <!-- 타이틀 -->
    <div id="account-title" aria-label="페이지 타이틀">
      <!-- 가운데 타이틀 이미지 -->
      <div class="title_text">마이페이지</div>
    </div>
    <!-- 상단 바 -->
    <table align="center" width="98%">
      <tbody>
        <tr>
          <td align="right">
            <!-- 회원정보 수정: 비밀번호 재확인 후 이동 -->
            <a href="{% url 'user:password_confirm' %}?next={% url 'user:profile_edit' %}">
              <img src="{% static 'images/account/my_modify.png' %}"
                   alt="정보수정"
                   border="0"
                   width="103"
                   height="21"
                   align="absmiddle">
            </a>
            <!-- 회원탈퇴: confirm 후 비밀번호 재확인 → 탈퇴 -->
            <a href="#" onclick="member_leave(event);">
              <img src="{% static 'images/account/my_leave.png' %}"
                   alt="회원탈퇴"
                   width="68"
                   height="21"
                   border="0"
                   align="absmiddle">
            </a>
          </td>
        </tr>
      </tbody>
    </table>
    <form id="accountDeleteForm"
          method="post"
          action="{% url 'user:account_delete' %}"
          style="display:none">
      {% csrf_token %}
    </form>
    <script>
              function member_leave(e){
                if(e) e.preventDefault();
                if (confirm("정말 회원에서 탈퇴 하시겠습니까?\n이 작업은 되돌릴 수 없습니다.")) {
                  document.getElementById('accountDeleteForm').submit();
                }
              }
    </script>
    <!-- 기본정보 박스 -->
    <div class="account-card">
      <div class="account-head">
        <!-- 아이콘은 필요 없으면 span만 남겨도 됩니다 -->
        <span aria-hidden="true">👤</span>
        <div class="account-head-title">회원 정보</div>
      </div>
      <div class="account-body">
        <div class="account-list">
          <div class="account-row">
            <div class="account-key">E-mail</div>
            <div class="account-val">{{ user_email }}</div>
          </div>
          <div class="account-row">
            <div class="account-key">회원가입일시</div>
            <div class="account-val">{{ date_joined|date:"Y-m-d" }}</div>
          </div>
          <div class="account-row">
            <div class="account-key">연락처</div>
            <div class="account-val">{{ user_hp }}</div>
          </div>
        </div>
      </div>
    </div>
    <br>
    <br>
    <br>
    <!-- 최근 주문내역 -->
    <div class="orders-card">
      <div class="orders-head">최근 주문내역</div>
      <div class="orders-body">
        <table class="orders-table">
          <thead>
            <tr>
              <th>주문일시</th>
              <th>상품명</th>
              <!-- 🔵 추가 -->
              <th>상품수</th>
              <th>주문금액</th>
            </tr>
          </thead>
          <tbody>
            {% for od in page_obj %}
              <tr>
                <td>{{ od.created_at|date:"Y-m-d H:i" }}</td>
                <!-- 🔵 상품명 셀: 최대 2개 표시 + 나머지는 '외 N개' -->
                <td class="tl" style="text-align:left">
                  {% with items=od.items.all %}
                    {% if items %}
                      {% for it in items|slice:":2" %}
                        {{ it.title }}
                        {% if not forloop.last %},{% endif %}
                      {% endfor %}
                      {% with total=items|length %}
                        {% if total > 2 %}외 {{ total|add:"-2" }}개{% endif %}
                      {% endwith %}
                    {% else %}
                      -
                    {% endif %}
                  {% endwith %}
                </td>
                <td>{{ od.item_count }}</td>
                <td>{{ od.total_amount|floatformat:0 }}원</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="orders-empty">주문 내역이 없습니다.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% if page_obj.has_other_pages %}
      <div class="pagination">
        {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}">이전</a>{% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <span class="current">{{ num }}</span>
          {% else %}
            <a href="?page={{ num }}">{{ num }}</a>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}">다음</a>{% endif %}
      </div>
    {% endif %}
  </div>
</td>
{% endblock content %}
<!-- 숨은 폼: CSRF 포함, POST로 바로 전송 -->
